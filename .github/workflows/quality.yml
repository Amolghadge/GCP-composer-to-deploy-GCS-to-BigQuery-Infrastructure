name: Development Testing

on:
  pull_request:
    branches:
      - develop
      - main
  push:
    branches:
      - develop

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint flake8 black isort

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 dags/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 dags/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with Black
        run: black --check dags/

      - name: Check import sorting with isort
        run: isort --check-only dags/

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check -recursive

      - name: Lint Terraform with TFLint
        uses: terraform-linters/setup-tflint@v3

      - name: Run TFLint
        working-directory: ./terraform
        run: |
          tflint --init
          tflint

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  dag-tests:
    name: DAG Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Initialize Airflow database
        run: |
          export AIRFLOW_HOME=$(pwd)
          export AIRFLOW__CORE__DAGS_FOLDER=$(pwd)/dags
          export AIRFLOW__CORE__LOAD_EXAMPLES=False
          export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow.db
          airflow db init

      - name: Create test directory
        run: mkdir -p tests

      - name: Create basic DAG test
        run: |
          cat > tests/test_dag.py << 'EOF'
          import sys
          import os
          sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../'))

          def test_dag_import():
              """Test that DAG can be imported without errors"""
              # Set up Airflow environment
              os.environ['AIRFLOW_HOME'] = os.path.dirname(__file__)
              os.environ['AIRFLOW__CORE__DAGS_FOLDER'] = os.path.join(os.path.dirname(__file__), '../dags')
              os.environ['AIRFLOW__CORE__LOAD_EXAMPLES'] = 'False'
              os.environ['AIRFLOW__DATABASE__SQL_ALCHEMY_CONN'] = 'sqlite:////tmp/airflow.db'
              
              from dags.gcs_to_bigquery_dag import dag
              assert dag is not None
              assert dag.dag_id == 'gcs_to_bigquery_dag'

          def test_dag_structure():
              """Test DAG has expected tasks"""
              os.environ['AIRFLOW_HOME'] = os.path.dirname(__file__)
              os.environ['AIRFLOW__CORE__DAGS_FOLDER'] = os.path.join(os.path.dirname(__file__), '../dags')
              os.environ['AIRFLOW__CORE__LOAD_EXAMPLES'] = 'False'
              os.environ['AIRFLOW__DATABASE__SQL_ALCHEMY_CONN'] = 'sqlite:////tmp/airflow.db'
              
              from dags.gcs_to_bigquery_dag import dag
              
              expected_tasks = [
                  'check_gcs_files',
                  'load_gcs_to_bigquery',
                  'validate_data_quality',
                  'merge_staging_to_main',
                  'archive_processed_files',
                  'send_notification'
              ]
              
              dag_tasks = [task.task_id for task in dag.tasks]
              for task in expected_tasks:
                  assert task in dag_tasks, f"Task {task} not found in DAG"

          def test_dag_schedule():
              """Test DAG has expected schedule"""
              os.environ['AIRFLOW_HOME'] = os.path.dirname(__file__)
              os.environ['AIRFLOW__CORE__DAGS_FOLDER'] = os.path.join(os.path.dirname(__file__), '../dags')
              os.environ['AIRFLOW__CORE__LOAD_EXAMPLES'] = 'False'
              os.environ['AIRFLOW__DATABASE__SQL_ALCHEMY_CONN'] = 'sqlite:////tmp/airflow.db'
              
              from dags.gcs_to_bigquery_dag import dag
              
              # Check schedule is set to daily (0 2 * * *)
              assert dag.schedule_interval is not None
              assert '0 2 * * *' in str(dag.schedule_interval)
          EOF

      - name: Run DAG tests
        run: |
          export AIRFLOW_HOME=$(pwd)
          export AIRFLOW__CORE__DAGS_FOLDER=$(pwd)/dags
          export AIRFLOW__CORE__LOAD_EXAMPLES=False
          export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow.db
          pytest tests/ -v --cov=dags

  docker-build:
    name: Docker Image Build (Optional)
    runs-on: ubuntu-latest
    if: false  # Enable if you use Docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: composer-dag:latest

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation exists
        run: |
          files=(
            "README.md"
            "SETUP.md"
            "DAG_DOCUMENTATION.md"
            "QUICKSTART.md"
            "requirements.txt"
            "Makefile"
          )
          
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing documentation: $file"
              exit 1
            fi
          done
          echo "✅ All documentation files present"

      - name: Validate markdown
        run: |
          pip install mdv
          for file in *.md; do
            echo "Checking $file..."
            # Basic markdown validation
            grep -q "^#" "$file" || echo "Warning: $file has no headers"
          done

  result:
    name: Quality Gate
    needs: [code-quality, terraform-lint, dag-tests, documentation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "❌ Code quality checks failed"
            exit 1
          fi
          
          if [ "${{ needs.terraform-lint.result }}" != "success" ]; then
            echo "❌ Terraform lint failed"
            exit 1
          fi
          
          if [ "${{ needs.dag-tests.result }}" != "success" ]; then
            echo "❌ DAG tests failed"
            exit 1
          fi
          
          if [ "${{ needs.documentation.result }}" != "success" ]; then
            echo "❌ Documentation check failed"
            exit 1
          fi
          
          echo "✅ All quality gates passed!"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All quality gates passed! Ready to merge.'
            });
